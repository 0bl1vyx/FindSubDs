#!/bin/bash

# --- Colors ---
# Using tput for compatibility and to avoid hardcoded escape sequences
RED=$(tput setaf 1)
GRN=$(tput setaf 2)
YLW=$(tput setaf 3)
BLU=$(tput setaf 4)
MAG=$(tput setaf 5)
CYN=$(tput setaf 6)
WHT=$(tput setaf 7)
BOLD=$(tput bold)
NC=$(tput sgr0) # No Color

# --- UI Functions ---
spinner_with_updates() {
    local pid=$1
    local name=$2
    local spin=('â ‹' 'â ™' 'â ¹' 'â ¸' 'â ¼' 'â ´' 'â ¦' 'â §' 'â ‡' 'â ')
    local i=0
    tput civis
    while kill -0 "$pid" 2>/dev/null; do
        printf "\r${MAG}${spin[$i]}${NC} ${BOLD}${name}...${NC}"
        i=$(( (i + 1) % 10 ))
        sleep 0.1
    done
    printf "\r$(tput el)" # Clear the line
    tput cnorm
}

banner() {
    echo -e "${BLU}${BOLD}"
    echo '    â”Œâ”€â”â”¬ â”¬â”Œâ” â”Œâ”€â”â”Œâ”¬â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”'
    echo '    â”œâ”€â”¤â””â”¬â”˜â”œâ”´â”â””â”€â” â”‚ â”œâ”€â”˜â”Œâ”€â”˜â”Œâ”€â”˜'
    echo '    â”´ â”´ â”´ â””â”€â”˜â””â”€â”˜ â”´ â”´  â””â”€â”˜â””â”€â”˜ v2.1'
    echo -e "          ${NC}${CYN}by 0bl1vyx${NC}"
}

stage() {
    echo -e "\n${BLU}${BOLD}[ ${WHT}âš™ï¸  ${BLU}] ${WHT}${1}${NC}"
}

summary() {
    local total_subs=$1
    local live_subs=$2
    local output_file=$3
    local duration=$4

    echo -e "\n${GRN}${BOLD}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${GRN}${BOLD}â”‚${NC}                ${WHT}ğŸ‰ Scan Summary ğŸ‰${NC}                ${GRN}${BOLD}â”‚${NC}"
    echo -e "${GRN}${BOLD}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
    echo -e "${GRN}${BOLD}â”‚${NC} ${CYN}â±ï¸  Run time:${NC}        ${WHT}${duration} seconds${NC}"
    echo -e "${GRN}${BOLD}â”‚${NC} ${CYN}ğŸ“¦ Total subdomains:${NC} ${WHT}${total_subs}${NC}"
    echo -e "${GRN}${BOLD}â”‚${NC} ${CYN}ğŸŒ Live subdomains:${NC}  ${WHT}${live_subs}${NC}"
    echo -e "${GRN}${BOLD}â”‚${NC} ${CYN}ğŸ’¾ Output files:${NC}      ${YLW}${output_file}, ${LIVEOUT}${NC}"
    echo -e "${GRN}${BOLD}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}\n"
}

usage() {
    banner
    echo -e "\n${WHT}A fast, parallel subdomain enumeration script that combines passive and active techniques.${NC}"
    echo -e "\n${BOLD}USAGE:${NC}"
    echo -e "  $0 -d <domain> -o <all_subs.txt> -l <live_subs.txt> [OPTIONS]"
    echo -e "\n${BOLD}REQUIRED ARGUMENTS:${NC}"
    echo -e "  ${YLW}-d${NC}    Target domain (e.g., example.com)"
    echo -e "  ${YLW}-o${NC}    Output file for all unique subdomains found"
    echo -e "  ${YLW}-l${NC}    Output file for live subdomains (responding to HTTP/S)"
    echo -e "\n${BOLD}OPTIONAL ARGUMENTS (for Brute-Forcing):${NC}"
    echo -e "  ${YLW}-w${NC}    Path to a wordlist for subdomain brute-forcing with puredns"
    echo -e "  ${YLW}-r${NC}    Path to a file of valid DNS resolvers for puredns"
    echo -e "  ${YLW}-h${NC}    Display this help menu and exit"
    echo -e "\n${BOLD}EXAMPLE:${NC}"
    echo -e "  ${CYN}$0 -d example.com -o subs.txt -l live.txt -w /path/to/words.txt -r /path/to/resolvers.txt${NC}\n"
    exit 1
}


# --- Argument Parsing ---
while getopts "d:o:l:w:r:h" opt; do
  case $opt in
    d) DOMAIN=$OPTARG ;;
    o) OUTPUT=$OPTARG ;;
    l) LIVEOUT=$OPTARG ;;
    w) WORDLIST=$OPTARG ;;
    r) RESOLVERS=$OPTARG ;;
    h) usage ;;
    *) usage ;;
  esac
done

# --- Prerequisite Checks ---

# Check for required tools
for tool in subfinder assetfinder sublist3r dnsx httpx findomain jq curl puredns; do
  if ! command -v "$tool" >/dev/null 2>&1; then
    echo -e "${RED}${BOLD}[âœ˜] Tool missing: ${tool}. Please install it first.${NC}"
    exit 1
  fi
done

# Validate required arguments
if [[ -z "$DOMAIN" || -z "$OUTPUT" || -z "$LIVEOUT" ]]; then
  usage
fi

# Validate optional brute-force arguments
if [[ (-n "$WORDLIST" && -z "$RESOLVERS") || (-z "$WORDLIST" && -n "$RESOLVERS") ]]; then
    echo -e "${RED}${BOLD}[!] Both -w (wordlist) and -r (resolvers) must be provided together for brute-forcing.${NC}"
    exit 1
fi
if [[ -n "$WORDLIST" && ! -f "$WORDLIST" ]]; then
    echo -e "${RED}${BOLD}[!] Wordlist file not found: $WORDLIST${NC}"
    exit 1
fi
if [[ -n "$RESOLVERS" && ! -f "$RESOLVERS" ]]; then
    echo -e "${RED}${BOLD}[!] Resolvers file not found: $RESOLVERS${NC}"
    exit 1
fi


# Check for existing output files
if [[ -f "$OUTPUT" || -f "$LIVEOUT" ]]; then
  echo -e "${YLW}${BOLD}[!] Output file(s) already exist. Overwrite? [y/N]${NC}"
  read -r confirm
  if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo -e "${RED}${BOLD}[âœ˜] Operation aborted by user.${NC}"
    exit 1
  fi
fi

# --- Main Execution ---
start_time=$SECONDS
clear
banner

echo -e "\n${WHT}${BOLD}TARGET:${NC} ${YLW}$DOMAIN${NC}"
echo -e "${WHT}${BOLD}OUTPUT:${NC} ${YLW}$OUTPUT${NC} | ${WHT}${BOLD}LIVE:${NC} ${YLW}$LIVEOUT${NC}"
if [[ -n "$WORDLIST" ]]; then
    echo -e "${WHT}${BOLD}MODE:${NC}   ${YLW}Passive + Brute-Force${NC}"
fi


# Temp files
SUBF=$(mktemp)
ASSET=$(mktemp)
SUBL=$(mktemp)
FINDO=$(mktemp)
CRT=$(mktemp)
WARCH=$(mktemp)
BRUTE=$(mktemp)
RESOLVED=$(mktemp)

trap 'rm -f "$SUBF" "$ASSET" "$SUBL" "$CRT" "$FINDO" "$WARCH" "$BRUTE" "$RESOLVED"; tput cnorm' EXIT

stage "Running passive enumeration tools in parallel"
(
  subfinder -d "$DOMAIN" -all -silent -o "$SUBF" > /dev/null 2>&1 &
  assetfinder --subs-only "$DOMAIN" > "$ASSET" 2>/dev/null &
  sublist3r -d "$DOMAIN" -o "$SUBL" > /dev/null 2>&1 &
  curl -s "https://crt.sh/?q=%25.${DOMAIN}&output=json" | jq -r '.[].name_value' 2>/dev/null | sed 's/\*\.//g' | sort -u > "$CRT" &
  findomain -t "$DOMAIN" -q > "$FINDO" 2>/dev/null &
  curl -s "http://web.archive.org/cdx/search/cdx?url=*.${DOMAIN}/*&output=text&fl=original&collapse=urlkey" | sed -e 's_https*://__' -e "s/\/.*//" -e 's/:.*//' -e 's/^www\.//' | sort -u > "$WARCH" &
  wait
) &
spinner_with_updates $! "Passive Enumeration"
echo -e "${GRN}${BOLD}â””â”€â”€ Done.${NC}"

# --- Brute-forcing (Optional) ---
if [[ -n "$WORDLIST" && -n "$RESOLVERS" ]]; then
  stage "Running puredns for brute-force enumeration"
  (puredns bruteforce "$WORDLIST" "$DOMAIN" -r "$RESOLVERS" -w "$BRUTE" --quiet >/dev/null 2>&1) &
  spinner_with_updates $! "Brute-forcing"
  echo -e "${GRN}${BOLD}â””â”€â”€ Done.${NC}"
fi


# --- UX IMPROVEMENT: Tree-style progress report ---
echo -e "\n${CYN}${BOLD}   Individual Tool Results:${NC}"
declare -A sources
sources["$SUBF"]="Subfinder"
sources["$ASSET"]="Assetfinder"
sources["$SUBL"]="Sublist3r"
sources["$CRT"]="crt.sh"
sources["$FINDO"]="Findomain"
sources["$WARCH"]="Web Archive"
sources["$BRUTE"]="PureDNS Brute"

for file in "${!sources[@]}"; do
    if [[ -s "$file" ]]; then
        count=$(wc -l < "$file" | tr -d ' ')
        printf "   ${BLU}â”œâ”€â”€ ${WHT}%-15s${NC}: %s results\n" "${sources[$file]}" "$count"
    fi
done

stage "Merging, resolving, and checking live hosts"
(cat "$SUBF" "$ASSET" "$SUBL" "$CRT" "$FINDO" "$WARCH" "$BRUTE" | sort -u > "$OUTPUT") &
spinner_with_updates $! "Merging results"
(dnsx -l "$OUTPUT" -silent -o "$RESOLVED" > /dev/null 2>&1) &
spinner_with_updates $! "Resolving domains"
(httpx -l "$RESOLVED" -silent -o "$LIVEOUT" > /dev/null 2>&1) &
spinner_with_updates $! "Checking live hosts"
echo -e "${GRN}${BOLD}â””â”€â”€ Done.${NC}"

# --- Summary ---
total=$(wc -l < "$OUTPUT" | tr -d ' ')
live=$(wc -l < "$LIVEOUT" | tr -d ' ')
duration=$(( SECONDS - start_time ))
summary "$total" "$live" "$OUTPUT" "$duration"
