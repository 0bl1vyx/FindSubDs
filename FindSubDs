#!/bin/bash

# Colors
RED='\033[0;31m'
GRN='\033[0;32m'
YLW='\033[1;33m'
CYN='\033[0;36m'
BLU='\033[1;34m'
MAG='\033[1;35m'
WHT='\033[1;37m'
NC='\033[0m' # No Color

# Tool Check
for tool in subfinder assetfinder sublist3r dnsx httpx; do
  if ! command -v "$tool" >/dev/null 2>&1; then
    echo -e "${RED}[âœ˜] Tool missing: ${tool}. Install it first.${NC}"
    exit 1
  fi
done

# Spinner (clean + no glitch)
spinner_with_updates() {
    local pid=$1
    local name=$2
    local spin=('â ‹' 'â ™' 'â ¹' 'â ¸' 'â ¼' 'â ´' 'â ¦' 'â §' 'â ‡' 'â ')
    local i=0
    tput civis  # Hide cursor
    while kill -0 "$pid" 2>/dev/null; do
        printf "\r${MAG}${spin[$i]}${NC} Running ${name}...$(tput el)"
        i=$(( (i + 1) % 10 ))
        sleep 0.1
    done
    tput cnorm  # Show cursor
    printf "\r$(tput el)"
}

# Banner (optimized)
banner() {
  echo -ne "${BLU}"
  for frame in "ðŸ”" "ðŸ”Ž" "ðŸ›°ï¸" "ðŸ•µï¸" "ðŸ“¡" "ðŸ”"; do
    printf "\r${WHT}Loading ${frame} FindSubDs...${NC}"
    sleep 0.1
  done
  echo -e "\n${BLU}"
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘               ðŸ” FindSubDs Tool               â•‘"
  echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
  echo -e "â•‘     Created with ðŸ’» by ${MAG}Crypt Specter${BLU}             â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo -e "${NC}"
}

# Stage title
stage() {
  echo -e "\n${CYN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo -e   "â•‘ ðŸ”§ ${WHT}${1}${CYN}"
  echo -e   "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  printf "${MAG}..." && printf "${GRN}..." && printf "${CYN}...\n${NC}"
}

# Final summary
summary() {
  echo -e "\n${GRN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo -e   "â•‘ ðŸŽ‰ Subdomain enumeration complete!"
  echo -e   "â•‘ ðŸ“¦ Total subdomains: ${CYN}$1${GRN}"
  echo -e   "â•‘ ðŸŒ Live subdomains: ${CYN}$2${GRN}"
  echo -e   "â•‘ ðŸ’¾ Files saved: ${YLW}$3${GRN}, $LIVEOUT"
  echo -e   "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

# Parse arguments
while getopts "d:o:l:" opt; do
  case $opt in
    d) DOMAIN=$OPTARG ;;
    o) OUTPUT=$OPTARG ;;
    l) LIVEOUT=$OPTARG ;;
    *) echo -e "${RED}[!] Usage: $0 -d domain.com -o output.txt -l live_output.txt${NC}" && exit 1 ;;
  esac
done

# Required flags check
if [[ -z "$DOMAIN" || -z "$OUTPUT" || -z "$LIVEOUT" ]]; then
  echo -e "${RED}[!] Missing required arguments!${NC}"
  echo "Usage: $0 -d domain.com -o output.txt -l live_output.txt"
  exit 1
fi

# Overwrite warning
if [[ -f "$OUTPUT" || -f "$LIVEOUT" ]]; then
  echo -e "${YLW}[!] Output file(s) already exist. Overwrite? [y/N]${NC}"
  read -r confirm
  if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo -e "${RED}[âœ˜] Operation aborted by user.${NC}"
    exit 1
  fi
fi

# UI Intro
clear
banner
echo -e "${YLW}ðŸ“¡ Target domain:${NC} $DOMAIN"
echo -e "${YLW}ðŸ—‚ï¸  Output file: ${NC} $OUTPUT"
echo -e "${YLW}ðŸŒ Live output : ${NC} $LIVEOUT"
echo -e "${CYN}Initializing modules...${NC}" && sleep 0.3
echo -ne "${MAG}Countdown to launch: " && for i in {3..1}; do printf "${WHT}$i " && sleep 0.5; done
echo -e "\n${NC}"

# Temp files
SUBF=$(mktemp)
ASSET=$(mktemp)
SUBL=$(mktemp)
RESOLVED=$(mktemp)

# Run subfinder
stage "Running subfinder..."
(subfinder -d "$DOMAIN" -all -silent -o "$SUBF" > /dev/null 2>&1) &
spinner_with_updates $! "subfinder"
echo -e "${GRN}[âœ”] subfinder complete!${NC}"

# Run assetfinder
stage "Running assetfinder..."
(assetfinder --subs-only "$DOMAIN" > "$ASSET" 2>/dev/null) &
spinner_with_updates $! "assetfinder"
echo -e "${GRN}[âœ”] assetfinder complete!${NC}"

# Run sublist3r
stage "Running sublist3r..."
(sublist3r -d "$DOMAIN" -o "$SUBL" > /dev/null 2>&1) &
spinner_with_updates $! "sublist3r"
echo -e "${GRN}[âœ”] sublist3r complete!${NC}"

# Merge & dedupe
stage "Merging & deduplicating results..."
(cat "$SUBF" "$ASSET" "$SUBL" | sort -u > "$OUTPUT") &
spinner_with_updates $! "merge"
echo -e "${GRN}[âœ”] All results merged successfully!${NC}"

# dnsx resolution
stage "Resolving subdomains with dnsx..."
(dnsx -l "$OUTPUT" -silent -o "$RESOLVED" > /dev/null 2>&1) &
spinner_with_updates $! "dnsx"
echo -e "${GRN}[âœ”] Resolution complete!${NC}"

# httpx live check
stage "Checking live subdomains with httpx..."
(httpx -l "$RESOLVED" -silent -o "$LIVEOUT" > /dev/null 2>&1) &
spinner_with_updates $! "httpx"
echo -e "${GRN}[âœ”] Live check complete!${NC}"

# Cleanup
rm -f "$SUBF" "$ASSET" "$SUBL" "$RESOLVED"

# Summary
total=$(wc -l < "$OUTPUT")
live=$(wc -l < "$LIVEOUT")
summary "$total" "$live" "$OUTPUT"
